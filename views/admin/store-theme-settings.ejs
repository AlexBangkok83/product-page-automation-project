<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <style>
        .store-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
        }
        
        .theme-selector-card {
            border: 2px solid #e9ecef;
            border-radius: 12px;
            transition: all 0.3s ease;
            background: white;
            height: 100%;
            cursor: pointer;
        }
        
        .theme-selector-card:hover {
            border-color: #667eea;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
            transform: translateY(-2px);
        }
        
        .theme-selector-card.selected {
            border-color: #28a745;
            background: #f8fff9;
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.15);
        }
        
        .theme-preview {
            height: 150px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px 10px 0 0;
            position: relative;
            overflow: hidden;
        }
        
        .theme-preview-mini {
            width: 80%;
            height: 80%;
            background: white;
            border: 2px dashed #ccc;
            display: flex;
            flex-direction: column;
            padding: 4px;
            font-size: 6px;
            color: #666;
            font-family: monospace;
        }
        
        .mini-header, .mini-main, .mini-footer {
            border: 1px solid #ddd;
            padding: 2px;
            margin: 1px 0;
            text-align: center;
        }
        
        .mini-header {
            background: var(--theme-primary, #667eea);
            color: white;
            height: 20%;
        }
        
        .mini-main {
            background: var(--theme-surface, #f9f9f9);
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .mini-footer {
            background: var(--theme-secondary, #764ba2);
            color: white;
            height: 20%;
        }
        
        .theme-info {
            padding: 1rem;
        }
        
        .selected-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #28a745;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        .theme-colors {
            display: flex;
            gap: 2px;
            margin-top: 0.5rem;
        }
        
        .theme-color-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 1px solid #ddd;
        }
        
        .settings-section {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .save-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
        }
        
        .content-area-preview {
            border: 2px dashed #007bff;
            background: rgba(0, 123, 255, 0.05);
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            text-align: center;
            color: #007bff;
            font-weight: 500;
        }
    </style>
</head>
<body class="bg-light admin-page">
    <!-- Include Admin Navigation -->
    <%- include('../partials/admin-nav') %>
    
    <div class="container-fluid">
        <!-- Store Header -->
        <div class="store-header">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h2 class="mb-1">
                        <i class="bi bi-palette me-2"></i><%= store.name %> - Theme Settings
                    </h2>
                    <p class="mb-0 opacity-75">
                        <i class="bi bi-link-45deg me-1"></i>Connected to: <%= store.shopify_domain || 'Default Shopify Store' %>
                    </p>
                    <p class="mb-0 opacity-75">
                        <i class="bi bi-globe me-1"></i>Domain: <%= store.domain %>
                    </p>
                </div>
                <div class="col-md-4 text-end">
                    <div class="d-flex gap-2 justify-content-end">
                        <a href="<%= store.deployment_url || '#' %>" target="_blank" class="btn btn-outline-light btn-sm">
                            <i class="bi bi-eye me-1"></i>Preview Store
                        </a>
                        <button class="btn save-btn btn-sm" onclick="saveThemeSettings()">
                            <i class="bi bi-check-lg me-1"></i>Save Changes
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Theme Selection -->
        <div class="settings-section">
            <h5 class="mb-3">
                <i class="bi bi-palette me-2"></i>Choose Theme
            </h5>
            <p class="text-muted mb-4">Select a theme to define the overall look and feel of your store</p>
            
            <div class="row" id="themesGrid">
                <% themes.forEach(theme => { %>
                    <div class="col-lg-3 col-md-4 col-sm-6 mb-4">
                        <div class="theme-selector-card <%= store.theme_id_new == theme.id ? 'selected' : '' %>" 
                             onclick="selectTheme(<%= theme.id %>, '<%= theme.name %>')" 
                             data-theme-id="<%= theme.id %>">
                            
                            <% if (store.theme_id_new == theme.id) { %>
                                <div class="selected-badge">
                                    <i class="bi bi-check"></i> Active
                                </div>
                            <% } %>
                            
                            <!-- Theme Preview -->
                            <div class="theme-preview">
                                <% 
                                let colors = {};
                                try {
                                    colors = JSON.parse(theme.css_variables || '{}');
                                } catch(e) {
                                    colors = {primary: '#667eea', secondary: '#764ba2', surface: '#f9f9f9'};
                                }
                                %>
                                <div class="theme-preview-mini" style="--theme-primary: <%= colors.primary || '#667eea' %>; --theme-secondary: <%= colors.secondary || '#764ba2' %>; --theme-surface: <%= colors.surface || '#f9f9f9' %>">
                                    <div class="mini-header">[HEADER]</div>
                                    <div class="mini-main">[CONTENT]</div>
                                    <div class="mini-footer">[FOOTER]</div>
                                </div>
                            </div>
                            
                            <!-- Theme Info -->
                            <div class="theme-info">
                                <h6 class="mb-1"><%= theme.name %></h6>
                                <% if (theme.description) { %>
                                    <p class="text-muted small mb-2"><%= theme.description %></p>
                                <% } %>
                                
                                <!-- Color Preview -->
                                <div class="theme-colors">
                                    <div class="theme-color-dot" style="background-color: <%= colors.primary || '#667eea' %>"></div>
                                    <div class="theme-color-dot" style="background-color: <%= colors.secondary || '#764ba2' %>"></div>
                                    <div class="theme-color-dot" style="background-color: <%= colors.accent || '#f093fb' %>"></div>
                                </div>
                                
                                <% if (theme.is_default) { %>
                                    <small class="text-success">
                                        <i class="bi bi-star-fill me-1"></i>Default Theme
                                    </small>
                                <% } %>
                            </div>
                        </div>
                    </div>
                <% }) %>
            </div>
        </div>
        
        <!-- Content Injection Areas -->
        <div class="settings-section">
            <h5 class="mb-3">
                <i class="bi bi-code-square me-2"></i>Content Injection Areas
            </h5>
            <p class="text-muted mb-4">These are the dynamic areas where admin content will be injected into your theme</p>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <h6><i class="bi bi-layout-navbar me-1"></i> Header Area</h6>
                    <div class="content-area-preview">
                        <i class="bi bi-cursor-text me-2"></i>
                        Logo, Navigation, Cart & Search
                        <br><small>Dynamically populated from store settings</small>
                    </div>
                </div>
                
                <div class="col-md-6 mb-3">
                    <h6><i class="bi bi-grid-3x3 me-1"></i> Main Content Area</h6>
                    <div class="content-area-preview">
                        <i class="bi bi-box-seam me-2"></i>
                        Product Pages, Collections, CMS Pages
                        <br><small>Product templates and page content inject here</small>
                    </div>
                </div>
                
                <div class="col-md-6 mb-3">
                    <h6><i class="bi bi-layout-sidebar me-1"></i> Product Template Area</h6>
                    <div class="content-area-preview">
                        <i class="bi bi-collection me-2"></i>
                        Product Images, Info, Add to Cart, etc.
                        <br><small>Selected product templates render here</small>
                    </div>
                </div>
                
                <div class="col-md-6 mb-3">
                    <h6><i class="bi bi-layout-footer me-1"></i> Footer Area</h6>
                    <div class="content-area-preview">
                        <i class="bi bi-link me-2"></i>
                        Links, Social, Newsletter, Copyright
                        <br><small>Configured through theme footer settings</small>
                    </div>
                </div>
                
                <div class="col-12 mb-3">
                    <h6><i class="bi bi-magic me-1"></i> Custom Page Content</h6>
                    <div class="content-area-preview">
                        <i class="bi bi-file-text me-2"></i>
                        About Us, Contact, Privacy Policy, Custom Pages
                        <br><small>Managed through Admin > Store > Content Editor</small>
                    </div>
                </div>
            </div>
            
            <div class="alert alert-info">
                <i class="bi bi-info-circle me-2"></i>
                <strong>Note:</strong> These content areas are automatically populated when you:
                <ul class="mb-0 mt-2">
                    <li>Assign product templates to products</li>
                    <li>Edit page content in the Content Editor</li>
                    <li>Configure store settings and branding</li>
                    <li>Set up Shopify product synchronization</li>
                </ul>
            </div>
        </div>
        
        <!-- Theme Preview -->
        <div class="settings-section">
            <h5 class="mb-3">
                <i class="bi bi-eye me-2"></i>Live Preview
            </h5>
            <p class="text-muted mb-4">See how your selected theme will look with content injection areas highlighted</p>
            
            <div class="border rounded" style="min-height: 400px; background: #f8f9fa;">
                <div id="livePreview" style="font-family: Arial, sans-serif;">
                    <!-- This will be populated by JavaScript based on selected theme -->
                    <div style="background: var(--selected-primary, #667eea); color: white; padding: 1rem; text-align: center;">
                        <strong>üé® HEADER INJECTION AREA</strong> - Logo, Navigation, Cart
                    </div>
                    <div style="padding: 2rem; background: white;">
                        <div style="border: 2px dashed #007bff; padding: 2rem; margin: 1rem 0; background: rgba(0,123,255,0.05); text-align: center; color: #007bff;">
                            <strong>üìÑ MAIN CONTENT INJECTION AREA</strong><br>
                            <small>Product pages, collections, and CMS content appear here</small>
                        </div>
                        <div style="border: 2px dashed #28a745; padding: 2rem; margin: 1rem 0; background: rgba(40,167,69,0.05); text-align: center; color: #28a745;">
                            <strong>üõçÔ∏è PRODUCT TEMPLATE INJECTION AREA</strong><br>
                            <small>Selected product templates with configured sections render here</small>
                        </div>
                    </div>
                    <div style="background: var(--selected-secondary, #764ba2); color: white; padding: 1rem; text-align: center;">
                        <strong>üîó FOOTER INJECTION AREA</strong> - Links, Social, Newsletter
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Save Actions -->
        <div class="text-center mb-4">
            <div class="btn-group">
                <a href="/admin" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left me-1"></i>Back to Dashboard
                </a>
                <a href="/admin/templates/assignments?store=<%= store.id %>" class="btn btn-outline-primary">
                    <i class="bi bi-collection me-1"></i>Manage Product Templates
                </a>
                <a href="/admin/store/<%= store.uuid %>/content" class="btn btn-outline-info">
                    <i class="bi bi-file-text me-1"></i>Edit Page Content
                </a>
                <button class="btn save-btn" onclick="saveThemeSettings()">
                    <i class="bi bi-check-lg me-1"></i>Save Theme Settings
                </button>
            </div>
        </div>
    </div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Success Modal -->
    <div class="modal fade" id="successModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-check-circle-fill text-success me-2"></i>
                        Theme Updated Successfully
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-3">Your store theme has been updated successfully!</p>
                    <div class="d-grid gap-2">
                        <a href="<%= store.deployment_url || '#' %>" class="btn btn-primary" target="_blank">
                            <i class="bi bi-eye me-2"></i>View Live Store
                        </a>
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                            Continue Editing
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let selectedThemeId = <%= store.theme_id_new || 'null' %>;
        
        function selectTheme(themeId, themeName) {
            // Remove previous selection
            document.querySelectorAll('.theme-selector-card').forEach(card => {
                card.classList.remove('selected');
                const badge = card.querySelector('.selected-badge');
                if (badge) badge.remove();
            });
            
            // Add selection to new theme
            const selectedCard = document.querySelector(`[data-theme-id="${themeId}"]`);
            selectedCard.classList.add('selected');
            
            // Add selected badge
            const badge = document.createElement('div');
            badge.className = 'selected-badge';
            badge.innerHTML = '<i class="bi bi-check"></i> Selected';
            selectedCard.querySelector('.theme-preview').appendChild(badge);
            
            selectedThemeId = themeId;
            
            // Update live preview colors (basic implementation)
            const themeData = extractThemeData(selectedCard);
            updateLivePreview(themeData);
            
            console.log(`Selected theme: ${themeName} (ID: ${themeId})`);
        }
        
        function extractThemeData(card) {
            const colorDots = card.querySelectorAll('.theme-color-dot');
            return {
                primary: colorDots[0]?.style.backgroundColor || '#667eea',
                secondary: colorDots[1]?.style.backgroundColor || '#764ba2'
            };
        }
        
        function updateLivePreview(themeData) {
            const preview = document.getElementById('livePreview');
            preview.style.setProperty('--selected-primary', themeData.primary);
            preview.style.setProperty('--selected-secondary', themeData.secondary);
        }
        
        async function saveThemeSettings() {
            if (!selectedThemeId) {
                alert('Please select a theme first');
                return;
            }
            
            try {
                const response = await fetch(`/admin/store/<%= store.id %>/theme`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ theme_id: selectedThemeId })
                });
                
                const result = await response.json();
                if (result.success) {
                    const modal = new bootstrap.Modal(document.getElementById('successModal'));
                    modal.show();
                } else {
                    alert('Failed to save theme: ' + result.error);
                }
            } catch (error) {
                alert('Failed to save theme: ' + error.message);
            }
        }
        
        // Initialize preview on page load
        document.addEventListener('DOMContentLoaded', function() {
            const selectedCard = document.querySelector('.theme-selector-card.selected');
            if (selectedCard) {
                const themeData = extractThemeData(selectedCard);
                updateLivePreview(themeData);
            }
        });
    </script>
</body>
</html>