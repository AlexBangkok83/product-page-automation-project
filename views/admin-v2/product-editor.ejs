<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Editor - MultiStore Platform</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <style>
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="flex h-screen">
        <!-- Sidebar -->
        <div class="w-64 bg-white border-r border-gray-200 flex flex-col">
            <!-- Logo/Brand -->
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex items-center">
                    <i data-lucide="store" class="w-8 h-8 text-blue-600"></i>
                    <span class="ml-2 text-lg font-semibold text-gray-900">MultiStore</span>
                </div>
            </div>
            
            <!-- Navigation -->
            <nav class="flex-1 px-4 py-6 space-y-1">
                <!-- Dashboard -->
                <a href="/admin-v2" class="flex items-center px-3 py-2 text-sm font-medium text-gray-700 hover:text-gray-900 hover:bg-gray-50 rounded-lg">
                    <i data-lucide="layout-dashboard" class="w-5 h-5 mr-3"></i>
                    Dashboard
                </a>
                
                <!-- Companies -->
                <div class="pt-4">
                    <div class="flex items-center px-3 py-2 text-xs font-semibold text-gray-500 uppercase tracking-wider">
                        Companies
                    </div>
                    <div class="mt-2 space-y-1 ml-3">
                        <a href="/admin-v2" class="flex items-center px-3 py-2 text-sm font-medium text-gray-700 hover:text-gray-900 hover:bg-gray-50 rounded-lg">
                            <i data-lucide="building-2" class="w-4 h-4 mr-3"></i>
                            Nextsite
                        </a>
                    </div>
                </div>
                
                <!-- Nextsite expanded -->
                <div class="ml-6 space-y-1">
                    <a href="/admin-v2/company/settings" class="flex items-center px-3 py-2 text-sm font-medium text-gray-600 hover:text-gray-900 hover:bg-gray-50 rounded-lg">
                        <i data-lucide="settings" class="w-4 h-4 mr-3"></i>
                        Company Settings
                    </a>
                    <a href="/admin-v2/company/design" class="flex items-center px-3 py-2 text-sm font-medium text-gray-600 hover:text-gray-900 hover:bg-gray-50 rounded-lg">
                        <i data-lucide="palette" class="w-4 h-4 mr-3"></i>
                        Design Library
                    </a>
                    <div class="pt-2">
                        <div class="flex items-center px-3 py-1 text-xs font-medium text-gray-500">
                            Shopify Connections
                        </div>
                        <div class="ml-3 mt-1 space-y-1">
                            <a href="/admin-v2/shopify/ecominter" class="flex items-center px-3 py-2 text-sm font-medium text-gray-600 hover:text-gray-900 hover:bg-gray-50 rounded-lg">
                                <i data-lucide="shopping-bag" class="w-4 h-4 mr-3"></i>
                                ecominter.myshopify.com
                            </a>
                            <div class="ml-6 space-y-1">
                                <a href="/admin-v2/store/882eacac-d9fa-411c-a9f8-7415c26240b9" class="flex items-center px-3 py-2 text-sm font-medium text-blue-700 bg-blue-50 rounded-lg">
                                    <i data-lucide="globe" class="w-3 h-3 mr-3"></i>
                                    clipia.de
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </nav>
            
            <!-- Bottom section -->
            <div class="px-4 py-4 border-t border-gray-200">
                <div class="flex items-center">
                    <div class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center">
                        <i data-lucide="user" class="w-4 h-4 text-gray-600"></i>
                    </div>
                    <div class="ml-3">
                        <div class="text-sm font-medium text-gray-900">Admin</div>
                        <div class="text-xs text-gray-500">admin@company.com</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- Header -->
            <header class="bg-white border-b border-gray-200 px-4 sm:px-6 py-4">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                    <div class="flex items-center space-x-4 mb-4 sm:mb-0">
                        <a href="/admin-v2/store/882eacac-d9fa-411c-a9f8-7415c26240b9" class="text-gray-500 hover:text-gray-700">
                            <i data-lucide="arrow-left" class="w-5 h-5"></i>
                        </a>
                        <div>
                            <h1 class="text-xl sm:text-2xl font-semibold text-gray-900">Edit Product: Elegante Solbriller</h1>
                            <p class="text-sm text-gray-500 mt-1">clipia.de</p>
                        </div>
                    </div>
                    <div class="flex flex-col sm:flex-row items-start sm:items-center space-y-2 sm:space-y-0 sm:space-x-4">
                        <a href="https://clipia.de/products/elegante-solbriller-for-alle" target="_blank" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50 w-full sm:w-auto justify-center">
                            <i data-lucide="external-link" class="w-4 h-4 mr-2"></i>
                            View Product
                        </a>
                        <div class="flex space-x-2 w-full sm:w-auto">
                            <button onclick="saveProduct()" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-lg text-white bg-blue-600 hover:bg-blue-700 flex-1 sm:flex-none justify-center">
                                <i data-lucide="save" class="w-4 h-4 mr-2"></i>
                                Save
                            </button>
                            <button onclick="deployProduct()" class="deploy-product-btn inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-lg text-white bg-green-600 hover:bg-green-700 flex-1 sm:flex-none justify-center">
                                <i data-lucide="rocket" class="w-4 h-4 mr-2"></i>
                                <span class="hidden sm:inline">Deploy to Live Site</span>
                                <span class="sm:hidden">Deploy</span>
                            </button>
                        </div>
                    </div>
                </div>
            </header>
            
            <!-- Main Content Area -->
            <main class="flex-1 overflow-hidden">
                <div class="h-full flex flex-col lg:flex-row">
                    <!-- Main Content - Template Configuration -->
                    <div class="flex-1 min-w-0 lg:min-w-[600px] xl:min-w-[800px] overflow-y-auto p-4 sm:p-6">
                        <div class="space-y-8">
                            
                            <!-- Template Configuration -->
                            <div id="template-preview" class="hidden">
                                <div class="bg-white rounded-xl border border-gray-200">
                                    <div class="px-6 py-4 border-b border-gray-200">
                                        <div class="flex items-center justify-between">
                                            <h3 class="text-lg font-medium text-gray-900">Template Configuration</h3>
                                            <div class="text-sm text-gray-600 bg-blue-50 px-3 py-1 rounded-lg">
                                                <i data-lucide="info" class="w-4 h-4 inline mr-2"></i>
                                                <span id="template-description">Configure your template elements below</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="p-6">
                                        <div id="template-fields" class="space-y-6">
                                            <!-- Template-specific fields will be loaded here -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Empty State -->
                            <div id="empty-template-state" class="bg-white rounded-xl border border-gray-200 p-12 text-center">
                                <div class="text-gray-400 mb-4">
                                    <i data-lucide="layout-template" class="w-16 h-16 mx-auto mb-4"></i>
                                </div>
                                <h3 class="text-lg font-medium text-gray-900 mb-2">No Template Selected</h3>
                                <p class="text-gray-600">Choose a template from the dropdown above to start customizing your product page.</p>
                            </div>

                            <!-- Basic Information (Shopify Data) -->
                            <div class="bg-gray-50 rounded-xl border border-gray-200">
                                <div class="px-6 py-4 border-b border-gray-200">
                                    <div class="flex items-center justify-between">
                                        <h3 class="text-lg font-medium text-gray-600">Product Information</h3>
                                        <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-green-100 text-green-800">
                                            <i data-lucide="link" class="w-3 h-3 mr-1"></i>
                                            Synced from Shopify
                                        </span>
                                    </div>
                                </div>
                                <div class="p-6 space-y-6 opacity-75">
                                    <div class="grid grid-cols-1 gap-6 md:grid-cols-2">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Product Title</label>
                                            <input type="text" value="Elegante Solbriller for Alle" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-600" readonly>
                                            <p class="text-xs text-gray-500 mt-1">Managed by Shopify</p>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Handle</label>
                                            <input type="text" value="elegante-solbriller-for-alle" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-500" disabled>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Price</label>
                                            <div class="relative">
                                                <span class="absolute left-3 top-2 text-gray-500">€</span>
                                                <input type="number" value="29.95" class="w-full pl-8 pr-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-600" readonly>
                                            </div>
                                            <p class="text-xs text-gray-500 mt-1">Managed by Shopify</p>
                                            </div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Compare at Price</label>
                                            <div class="relative">
                                                <span class="absolute left-3 top-2 text-gray-500">€</span>
                                                <input type="number" value="39.95" class="w-full pl-8 pr-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-600" readonly>
                                            </div>
                                            <p class="text-xs text-gray-500 mt-1">Managed by Shopify</p>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                                        <textarea rows="6" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-600" readonly>Premium sunglasses for every occasion. Our elegant sunglasses combine style and functionality with UV protection and durable frames. Perfect for any outdoor activity or fashion statement.</textarea>
                                        <p class="text-xs text-gray-500 mt-1">Managed by Shopify</p>
                                    </div>
                                </div>
                            </div>
                            
                        </div>
                    </div>
                    
                    <!-- Sidebar -->
                    <div class="w-full lg:w-80 xl:w-80 lg:max-w-80 xl:max-w-80 lg:flex-shrink-0 bg-white border-t lg:border-t-0 lg:border-l border-gray-200 overflow-y-auto">
                        <div class="p-6 space-y-6">
                            
                            <!-- Current Template Selection -->
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h3 class="text-sm font-medium text-gray-900 mb-3">Current Template</h3>
                                <div class="space-y-3">
                                    <select id="template-selector" class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" onchange="loadTemplate()">
                                        <option value="">Select Template</option>
                                        <!-- Templates will be loaded dynamically -->
                                    </select>
                                    <div id="sidebar-template-info">
                                        <p class="text-sm text-gray-500">No template selected</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Product Info (Shopify Data) -->
                            <div>
                                <div class="flex items-center justify-between mb-3">
                                    <h3 class="text-sm font-medium text-gray-900">Product Information</h3>
                                    <button id="sync-shopify-btn" onclick="syncFromShopify()" class="inline-flex items-center px-2 py-1 text-xs font-medium text-blue-600 hover:text-blue-700 hover:bg-blue-50 rounded-md transition-colors">
                                        <i data-lucide="refresh-cw" class="w-3 h-3 mr-1"></i>
                                        Sync
                                    </button>
                                </div>
                                <div class="space-y-3">
                                    <div class="flex items-center justify-between text-sm">
                                        <span class="text-gray-500">Title:</span>
                                        <span class="text-gray-900 font-medium" data-product-field="title">Elegante Solbriller</span>
                                    </div>
                                    <div class="flex items-center justify-between text-sm">
                                        <span class="text-gray-500">Price:</span>
                                        <span class="text-gray-900 font-medium" data-product-field="price">€29.95</span>
                                    </div>
                                    <div class="flex items-center justify-between text-sm">
                                        <span class="text-gray-500">Compare at:</span>
                                        <span class="text-gray-900 font-medium" data-product-field="compare-price">€39.95</span>
                                    </div>
                                    <div class="flex items-center justify-between text-sm">
                                        <span class="text-gray-500">Status:</span>
                                        <span data-product-field="availability">
                                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">In Stock</span>
                                        </span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Product Images -->
                            <div>
                                <h3 class="text-sm font-medium text-gray-900 mb-3">Images</h3>
                                <div class="grid grid-cols-3 gap-2">
                                    <div class="aspect-square bg-gray-200 rounded-lg flex items-center justify-center border-2 border-blue-500">
                                        <i data-lucide="image" class="w-4 h-4 text-gray-400"></i>
                                    </div>
                                    <div class="aspect-square bg-gray-200 rounded-lg flex items-center justify-center">
                                        <i data-lucide="image" class="w-4 h-4 text-gray-400"></i>
                                    </div>
                                    <div class="aspect-square border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center">
                                        <i data-lucide="plus" class="w-4 h-4 text-gray-400"></i>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Publishing -->
                            <div>
                                <h3 class="text-sm font-medium text-gray-900 mb-3">Publishing</h3>
                                <div class="space-y-3">
                                    <div>
                                        <label class="block text-xs font-medium text-gray-700 mb-1">Status</label>
                                        <select class="w-full text-sm px-2 py-1 border border-gray-300 rounded">
                                            <option>Active</option>
                                            <option>Draft</option>
                                            <option>Archived</option>
                                        </select>
                                    </div>
                                    <button onclick="saveProduct(event)" class="w-full bg-blue-600 text-white px-3 py-2 rounded text-sm hover:bg-blue-700">
                                        Save Changes
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Organization -->
                            <div>
                                <h3 class="text-sm font-medium text-gray-900 mb-3">Organization</h3>
                                <div class="space-y-3">
                                    <div>
                                        <label class="block text-xs font-medium text-gray-700 mb-1">Product Type</label>
                                        <input type="text" value="Accessories" class="w-full text-sm px-2 py-1 border border-gray-300 rounded">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-700 mb-1">Tags</label>
                                        <input type="text" value="sunglasses, accessories, fashion" class="w-full text-sm px-2 py-1 border border-gray-300 rounded">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- SEO -->
                            <div>
                                <h3 class="text-sm font-medium text-gray-900 mb-3">Search Engine Listing</h3>
                                <div class="space-y-3">
                                    <div>
                                        <label class="block text-xs font-medium text-gray-700 mb-1">Meta Title</label>
                                        <input type="text" value="Elegante Solbriller - Premium Sunglasses" class="w-full text-sm px-2 py-1 border border-gray-300 rounded">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-700 mb-1">Meta Description</label>
                                        <textarea rows="2" class="w-full text-sm px-2 py-1 border border-gray-300 rounded">Premium sunglasses with UV protection.</textarea>
                                    </div>
                                </div>
                            </div>
                            
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <script>
        lucide.createIcons();
        
        // Load available templates
        async function loadAvailableTemplates() {
            try {
                const response = await fetch('/admin-v2/templates');
                const data = await response.json();
                
                const selector = document.getElementById('template-selector');
                selector.innerHTML = '<option value="">No template selected</option>';
                
                if (data.success && data.templates) {
                    data.templates.forEach(template => {
                        const option = document.createElement('option');
                        option.value = template.id;
                        option.textContent = template.name;
                        selector.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading templates:', error);
            }
        }
        
        // Load existing template assignment for this product
        async function loadExistingTemplate() {
            try {
                const pathParts = window.location.pathname.split('/');
                const productHandle = pathParts[pathParts.length - 2]; // Get the handle before '/edit'
                const response = await fetch(`/admin-v2/products/${productHandle}/template`);
                const data = await response.json();
                
                if (data.success && data.assignment) {
                    console.log('Loading existing assignment:', data.assignment);
                    
                    // Store the template data for later population
                    const savedTemplateData = data.assignment.template_data ? JSON.parse(data.assignment.template_data) : {};
                    
                    // Set the template selector
                    const selector = document.getElementById('template-selector');
                    selector.value = data.assignment.template_id;
                    
                    // Load the template and wait for it to complete
                    await loadTemplate();
                    
                    // Give a small delay to ensure template fields are rendered
                    await new Promise(resolve => setTimeout(resolve, 200));
                    
                    // Populate the field values if they exist
                    if (Object.keys(savedTemplateData).length > 0) {
                        console.log('Populating field data:', savedTemplateData);
                        
                        Object.keys(savedTemplateData).forEach(fieldId => {
                            const input = document.getElementById(fieldId);
                            if (input) {
                                if (input.type === 'checkbox') {
                                    input.checked = savedTemplateData[fieldId];
                                } else {
                                    input.value = savedTemplateData[fieldId];
                                }
                                console.log('Set field', fieldId, 'to', savedTemplateData[fieldId]);
                            } else {
                                console.warn('Field not found:', fieldId);
                            }
                        });
                    }
                } else {
                    console.log('No existing template assignment found');
                }
            } catch (error) {
                console.error('Error loading existing template:', error);
            }
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async function() {
            await loadAvailableTemplates();
            await loadExistingTemplate();
            
            // Check if a template is already selected and update UI accordingly
            const selector = document.getElementById('template-selector');
            if (selector && selector.value) {
                console.log('🔧 Template already selected on page load:', selector.value);
                await loadTemplate();
            }
        });
        
        // Load template when selected
        async function loadTemplate() {
            const selector = document.getElementById('template-selector');
            const templateId = selector.value;
            const preview = document.getElementById('template-preview');
            const emptyState = document.getElementById('empty-template-state');
            const sidebarInfo = document.getElementById('sidebar-template-info');
            
            if (!templateId) {
                preview.classList.add('hidden');
                emptyState.classList.remove('hidden');
                if (sidebarInfo) {
                    sidebarInfo.innerHTML = '<p class="text-sm text-gray-500">No template selected</p>';
                }
                return;
            }
            
            try {
                // Fetch template details
                const response = await fetch(`/admin-v2/templates/${templateId}`);
                const data = await response.json();
                
                if (data.success && data.template) {
                    const template = data.template;
                    
                    // Show preview and hide empty state
                    preview.classList.remove('hidden');
                    emptyState.classList.add('hidden');
                    
                    // Update sidebar info
                    if (sidebarInfo) {
                        sidebarInfo.innerHTML = `
                            <p class="text-sm text-gray-700 font-medium">${template.name}</p>
                            <p class="text-xs text-gray-500 mt-1">${template.description}</p>
                        `;
                    }
                    
                    document.getElementById('template-description').textContent = 
                        `Template: ${template.name}${template.description ? ' - ' + template.description : ''}`;
                    
                    // Generate template fields
                    generateTemplateFields(template);
                } else {
                    console.error('Failed to load template:', data.error);
                }
            } catch (error) {
                console.error('Error loading template:', error);
                preview.classList.remove('hidden');
                document.getElementById('template-description').textContent = 
                    `Template selected: ${selector.options[selector.selectedIndex].text}. Error loading configuration.`;
            }
        }
        
        // Generate template-specific fields
        function generateTemplateFields(template) {
            const fieldsContainer = document.getElementById('template-fields');
            let elements;
            
            try {
                elements = typeof template.elements === 'string' ? JSON.parse(template.elements) : template.elements;
            } catch (e) {
                console.error('Error parsing template elements:', e);
                fieldsContainer.innerHTML = '<p class="text-sm text-red-600">Error loading template configuration</p>';
                return;
            }
            
            let fieldsHTML = '';
            
            if (Array.isArray(elements)) {
                elements.forEach((element, index) => {
                    fieldsHTML += generateFieldHTML(element, index);
                });
            }
            
            if (!fieldsHTML) {
                fieldsHTML = '<p class="text-sm text-gray-500">This template has no configurable fields.</p>';
            }
            
            fieldsContainer.innerHTML = fieldsHTML;
        }
        
        // Generate HTML for individual template fields
        function generateFieldHTML(element, index) {
            const elementType = typeof element === 'string' ? element : element.type;
            
            const fieldMap = {
                'FreeShippingBar': {
                    title: 'Free Shipping Bar',
                    fields: [
                        { name: 'message', label: 'Shipping Message', type: 'text', placeholder: 'Free shipping on orders over $50!' }
                    ]
                },
                'FreeShippingTeaser': {
                    title: 'Free Shipping Teaser',
                    fields: [
                        { name: 'threshold', label: 'Free Shipping Threshold', type: 'number', placeholder: '50' },
                        { name: 'message', label: 'Teaser Message', type: 'text', placeholder: 'Free shipping on orders over $50!' }
                    ]
                },
                'FlashSaleCountdown': {
                    title: 'Flash Sale Timer',
                    fields: [
                        { name: 'end_date', label: 'Sale End Date', type: 'datetime-local' },
                        { name: 'title', label: 'Sale Title', type: 'text', placeholder: 'Limited Time Offer!' }
                    ]
                },
                'NavigationBar': {
                    title: 'Navigation Bar',
                    fields: [
                        { name: 'show_breadcrumbs', label: 'Show Breadcrumbs', type: 'checkbox' },
                        { name: 'sticky', label: 'Sticky Navigation', type: 'checkbox' }
                    ]
                },
                'ProductImageGallery': {
                    title: 'Product Image Gallery',
                    fields: [
                        { name: 'show_thumbnails', label: 'Show Thumbnails', type: 'checkbox' },
                        { name: 'enable_zoom', label: 'Enable Zoom', type: 'checkbox' },
                        { name: 'gallery_layout', label: 'Gallery Layout', type: 'select', options: ['grid', 'carousel', 'stack'] }
                    ]
                },
                'ProductTitle': {
                    title: 'Product Title Settings',
                    fields: [
                        { name: 'subtitle', label: 'Subtitle', type: 'text', placeholder: 'Optional subtitle' },
                        { name: 'show_vendor', label: 'Show Brand/Vendor', type: 'checkbox' }
                    ]
                },
                'StarRating': {
                    title: 'Star Rating Display',
                    fields: [
                        { name: 'show_count', label: 'Show Review Count', type: 'checkbox' },
                        { name: 'allow_reviews', label: 'Allow New Reviews', type: 'checkbox' }
                    ]
                },
                'PricingSection': {
                    title: 'Pricing Display',
                    fields: [
                        { name: 'show_savings', label: 'Show Savings Amount', type: 'checkbox' },
                        { name: 'currency_symbol', label: 'Currency Symbol', type: 'text', placeholder: '$' }
                    ]
                },
                'QuickBuyButton': {
                    title: 'Quick Buy Button',
                    fields: [
                        { name: 'button_text', label: 'Button Text', type: 'text', placeholder: 'Quick Buy' },
                        { name: 'show_quantity', label: 'Show Quantity Selector', type: 'checkbox' }
                    ]
                },
                'FreeTextField': {
                    title: 'Custom Text Content',
                    fields: [
                        { name: 'content', label: 'Text Content', type: 'textarea', placeholder: 'Enter your custom text here...' }
                    ]
                },
                'ListSection': {
                    title: 'Features List',
                    fields: [
                        { name: 'title', label: 'List Title', type: 'text', placeholder: 'Key Features' },
                        { name: 'items', label: 'List Items (one per line)', type: 'textarea', placeholder: 'Feature 1\nFeature 2\nFeature 3' }
                    ]
                },
                'SocialProof': {
                    title: 'Social Proof',
                    fields: [
                        { name: 'testimonial', label: 'Customer Testimonial', type: 'textarea', placeholder: 'Great product, love it!' },
                        { name: 'customer_name', label: 'Customer Name', type: 'text', placeholder: 'John D.' }
                    ]
                },
                'GuaranteeBadge': {
                    title: 'Guarantee Information',
                    fields: [
                        { name: 'guarantee_text', label: 'Guarantee Text', type: 'text', placeholder: '30-Day Money Back Guarantee' },
                        { name: 'guarantee_details', label: 'Guarantee Details', type: 'textarea', placeholder: 'Full refund if not satisfied...' }
                    ]
                },
                'Bundles': {
                    title: 'Product Bundles',
                    fields: [
                        { name: 'bundle_title', label: 'Bundle Title', type: 'text', placeholder: 'Frequently bought together' },
                        { name: 'discount_percentage', label: 'Bundle Discount %', type: 'number', placeholder: '10' }
                    ]
                },
                'ATCButton': {
                    title: 'Add to Cart Button',
                    fields: [
                        { name: 'button_text', label: 'Button Text', type: 'text', placeholder: 'Add to Cart' },
                        { name: 'show_quantity', label: 'Show Quantity Selector', type: 'checkbox' },
                        { name: 'enable_wishlist', label: 'Enable Wishlist', type: 'checkbox' }
                    ]
                },
                'TrustIndicators': {
                    title: 'Trust Indicators',
                    fields: [
                        { name: 'security_badges', label: 'Show Security Badges', type: 'checkbox' },
                        { name: 'payment_icons', label: 'Show Payment Icons', type: 'checkbox' }
                    ]
                },
                'SecureCheckout': {
                    title: 'Secure Checkout Badge',
                    fields: [
                        { name: 'badge_text', label: 'Badge Text', type: 'text', placeholder: 'Secure Checkout' },
                        { name: 'show_ssl', label: 'Show SSL Certificate', type: 'checkbox' }
                    ]
                },
                'ScarcityNotice': {
                    title: 'Urgency Message',
                    fields: [
                        { name: 'message', label: 'Scarcity Message', type: 'text', placeholder: 'Only 3 left in stock!' },
                        { name: 'show_countdown', label: 'Show Countdown Timer', type: 'checkbox' }
                    ]
                },
                'DiscountBadge': {
                    title: 'Discount Badge',
                    fields: [
                        { name: 'discount_text', label: 'Discount Text', type: 'text', placeholder: 'SAVE 25%' },
                        { name: 'badge_color', label: 'Badge Color', type: 'color', placeholder: '#ff0000' }
                    ]
                },
                'SalesCounter': {
                    title: 'Sales Counter',
                    fields: [
                        { name: 'sales_text', label: 'Sales Text', type: 'text', placeholder: 'people bought this today' },
                        { name: 'counter_start', label: 'Counter Start Number', type: 'number', placeholder: '15' }
                    ]
                }
            };
            
            const config = fieldMap[elementType];
            if (!config) {
                console.warn('No field configuration found for element type:', elementType);
                return '';
            }
            
            let html = `<div class="bg-gray-50 p-4 rounded-lg">`;
            html += `<h5 class="font-medium text-gray-900 mb-3">${config.title}</h5>`;
            
            config.fields.forEach((field, fieldIndex) => {
                const fieldId = `template_${elementType}_${field.name}`;
                
                html += `<div class="mb-3">`;
                html += `<label for="${fieldId}" class="block text-sm font-medium text-gray-700 mb-1">${field.label}</label>`;
                
                if (field.type === 'textarea') {
                    html += `<textarea id="${fieldId}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" rows="3" placeholder="${field.placeholder || ''}"></textarea>`;
                } else if (field.type === 'checkbox') {
                    html += `<div class="flex items-center">`;
                    html += `<input type="checkbox" id="${fieldId}" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">`;
                    html += `<label for="${fieldId}" class="ml-2 text-sm text-gray-700">${field.label}</label>`;
                    html += `</div>`;
                } else if (field.type === 'select') {
                    html += `<select id="${fieldId}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">`;
                    if (field.options) {
                        field.options.forEach(option => {
                            html += `<option value="${option}">${option.charAt(0).toUpperCase() + option.slice(1)}</option>`;
                        });
                    }
                    html += `</select>`;
                } else {
                    html += `<input type="${field.type}" id="${fieldId}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="${field.placeholder || ''}">`;
                }
                
                html += `</div>`;
            });
            
            html += `</div>`;
            return html;
        }
        
        // Sync product data from Shopify
        async function syncFromShopify() {
            const syncBtn = document.getElementById('sync-shopify-btn');
            const originalText = syncBtn.innerHTML;
            
            try {
                // Show loading state
                syncBtn.innerHTML = '<i data-lucide="loader-2" class="w-3 h-3 mr-1 animate-spin"></i>Syncing...';
                syncBtn.disabled = true;
                
                // Get current product handle from URL
                const pathSegments = window.location.pathname.split('/');
                const productHandle = pathSegments[pathSegments.indexOf('product') + 1];
                
                const response = await fetch(`/admin-v2/product/${productHandle}/sync`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Update the Product Information display with fresh data
                    updateProductInfoDisplay(result.product);
                    
                    // Show success notification
                    showNotification('Product synced successfully from Shopify!', 'success');
                } else {
                    throw new Error(result.error || 'Failed to sync from Shopify');
                }
            } catch (error) {
                console.error('Error syncing from Shopify:', error);
                showNotification('Failed to sync from Shopify: ' + error.message, 'error');
            } finally {
                // Restore button state
                syncBtn.innerHTML = originalText;
                syncBtn.disabled = false;
                lucide.createIcons();
            }
        }
        
        // Update Product Information display
        function updateProductInfoDisplay(product) {
            // Update title
            const titleElement = document.querySelector('[data-product-field="title"]');
            if (titleElement && product.title) {
                titleElement.textContent = product.title;
            }
            
            // Update price
            const priceElement = document.querySelector('[data-product-field="price"]');
            if (priceElement && product.variants && product.variants.length > 0) {
                const price = product.variants[0].price;
                priceElement.textContent = `€${(price / 100).toFixed(2)}`;
            }
            
            // Update compare at price
            const compareElement = document.querySelector('[data-product-field="compare-price"]');
            if (compareElement && product.variants && product.variants.length > 0 && product.variants[0].compare_at_price) {
                const comparePrice = product.variants[0].compare_at_price;
                compareElement.textContent = `€${(comparePrice / 100).toFixed(2)}`;
            }
            
            // Update availability
            const availabilityElement = document.querySelector('[data-product-field="availability"]');
            if (availabilityElement) {
                const isAvailable = product.availableForSale;
                availabilityElement.innerHTML = isAvailable 
                    ? '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">In Stock</span>'
                    : '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">Out of Stock</span>';
            }
        }
        
        // Simple notification system
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 px-4 py-3 rounded-lg shadow-lg z-50 ${
                type === 'success' ? 'bg-green-500 text-white' : 
                type === 'error' ? 'bg-red-500 text-white' : 
                'bg-blue-500 text-white'
            }`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 4000);
        }
        
        // Save product with template data
        async function saveProduct() {
            const saveBtn = event.target;
            const originalText = saveBtn.innerHTML;
            
            try {
                // Show loading state
                saveBtn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 mr-2 animate-spin"></i>Saving...';
                saveBtn.disabled = true;
                
                // Get selected template
                const templateSelector = document.getElementById('template-selector');
                const templateId = templateSelector.value;
                
                // Collect template field data
                const templateData = {};
                if (templateId) {
                    const templateFields = document.getElementById('template-fields');
                    const inputs = templateFields.querySelectorAll('input, textarea, select');
                    
                    inputs.forEach(input => {
                        if (input.type === 'checkbox') {
                            templateData[input.id] = input.checked;
                        } else {
                            templateData[input.id] = input.value;
                        }
                    });
                }
                
                // Save to backend
                const pathParts = window.location.pathname.split('/');
                const productHandle = pathParts[pathParts.length - 2]; // Get the handle before '/edit'
                const response = await fetch(`/admin-v2/products/${productHandle}/template`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        templateId: templateId || null,
                        templateData: templateData
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Show success message
                    const successMsg = document.createElement('div');
                    successMsg.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
                    successMsg.innerHTML = '<i data-lucide="check-circle" class="w-4 h-4 inline mr-2"></i>Product saved successfully!';
                    document.body.appendChild(successMsg);
                    
                    // Remove message after 3 seconds
                    setTimeout(() => {
                        successMsg.remove();
                    }, 3000);
                } else {
                    alert('Failed to save product: ' + result.error);
                }
            } catch (error) {
                console.error('Error saving product:', error);
                alert('Error saving product: ' + error.message);
            } finally {
                // Restore button
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
                lucide.createIcons();
            }
        }

        async function deployProduct() {
            const deployBtn = document.querySelector('.deploy-product-btn');
            const originalText = deployBtn.innerHTML;
            
            try {
                // Show loading state
                deployBtn.innerHTML = '<i data-lucide="loader" class="w-4 h-4 mr-2 animate-spin"></i>Deploying...';
                deployBtn.disabled = true;
                
                // Get product handle from URL
                const pathParts = window.location.pathname.split('/');
                const productHandle = pathParts[pathParts.length - 2];
                
                const response = await fetch(`/admin-v2/products/${productHandle}/deploy`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Show success message with live URL
                    const successMsg = document.createElement('div');
                    successMsg.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-4 rounded-lg shadow-lg z-50 max-w-md';
                    successMsg.innerHTML = `
                        <div class="flex items-start">
                            <i data-lucide="check-circle" class="w-5 h-5 mr-3 mt-0.5"></i>
                            <div>
                                <div class="font-semibold">Deployed Successfully!</div>
                                <div class="text-sm mt-1">
                                    Live URL: <a href="${result.liveUrl}" target="_blank" class="underline hover:no-underline">${result.liveUrl}</a>
                                </div>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(successMsg);
                    
                    // Remove message after 8 seconds
                    setTimeout(() => {
                        successMsg.remove();
                    }, 8000);
                    
                    lucide.createIcons();
                } else {
                    // Show error message
                    const errorMsg = document.createElement('div');
                    errorMsg.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
                    errorMsg.innerHTML = '<i data-lucide="alert-circle" class="w-4 h-4 inline mr-2"></i>Deployment failed: ' + result.error;
                    document.body.appendChild(errorMsg);
                    
                    setTimeout(() => {
                        errorMsg.remove();
                    }, 5000);
                    
                    lucide.createIcons();
                }
            } catch (error) {
                console.error('Error deploying product:', error);
                
                const errorMsg = document.createElement('div');
                errorMsg.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
                errorMsg.innerHTML = '<i data-lucide="alert-circle" class="w-4 h-4 inline mr-2"></i>Error: ' + error.message;
                document.body.appendChild(errorMsg);
                
                setTimeout(() => {
                    errorMsg.remove();
                }, 5000);
                
                lucide.createIcons();
            } finally {
                // Restore button
                deployBtn.innerHTML = originalText;
                deployBtn.disabled = false;
                lucide.createIcons();
            }
        }
    </script>
</body>
</html>